---
# tasks file for llm_tools

- name: Ensure Docker network exists
  community.docker.docker_network:
    name: "{{ llm_network_name }}"
    state: present
  become: true

- name: Start Open-WebUI container
  community.docker.docker_container:
    name: open-webui
    image: ghcr.io/open-webui/open-webui:dev
    pull: always
    restart_policy: unless-stopped
    networks:
      - name: "{{ llm_network_name }}"
    env:
      OLLAMA_BASE_URL: "{{ ollama_base_url_for_webui }}"
    volumes:
      - open-webui:/app/backend/data
    ports:
      - "{{ open_webui_http_port }}:8080"
    labels:
      wud.tag.include: main
      wud.watch.digest: "true"
      homepage.group: "{{ services['open-webui'].group }}"
      homepage.name: "{{ services['open-webui'].name }}"
      homepage.href: https://open-webui.lan
      homepage.icon: openai.png
      homepage.server: "{{ inventory_hostname }}"
      homepage.container: open-webui
  become: true

# Block for mcp-proxy setup
- name: MCP-Proxy Setup
  become: true
  block:
    - name: Ensure old mcp-bridge container is removed to free up port
      community.docker.docker_container:
        name: "mcp-bridge-container"
        state: absent

    - name: Define MCP-Proxy related facts
      ansible.builtin.set_fact:
        mcp_proxy_config_full_host_path: "{{ mcp_proxy_config_dir_host }}/{{ mcp_proxy_config_filename }}"
        mcp_proxy_build_context_path: "{{ mcp_proxy_config_dir_host }}/build"

    - name: Ensure mcp-proxy build directory exists
      ansible.builtin.file:
        path: "{{ mcp_proxy_build_context_path }}"
        state: directory
        mode: "0755"

    - name: Template custom Dockerfile for mcp-proxy
      ansible.builtin.template:
        src: Dockerfile.mcp-proxy.j2
        dest: "{{ mcp_proxy_build_context_path }}/Dockerfile"
        mode: "0644"
      register: dockerfile_result

    - name: Build the custom mcp-proxy image
      community.docker.docker_image:
        name: "{{ mcp_proxy_image_custom }}"
        source: build
        force_source: "{{ dockerfile_result.changed or force_update | default(false) }}"
        build:
          path: "{{ mcp_proxy_build_context_path }}"
          pull: true
          rm: true
        state: present

    - name: Ensure mcp-proxy config directory exists on host
      ansible.builtin.file:
        path: "{{ mcp_proxy_config_dir_host }}"
        state: directory
        mode: "0755"

    - name: Template mcp-proxy servers.json
      ansible.builtin.template:
        src: mcp_proxy_servers.json.j2
        dest: "{{ mcp_proxy_config_full_host_path }}"
        mode: "0644"
      notify: Restart MCP-Proxy container

    - name: Start the mcp-proxy container
      community.docker.docker_container:
        name: "{{ mcp_proxy_container_name }}"
        image: "{{ mcp_proxy_image_custom }}"
        state: started
        detach: true
        ports:
          - "{{ mcp_proxy_service_port }}:{{ mcp_proxy_service_port }}"
        volumes:
          - "{{ mcp_proxy_config_full_host_path }}:/app/servers.json:ro"
        command:
          - "--port"
          - "{{ mcp_proxy_service_port }}"
          - "--host"
          - "0.0.0.0"
          - "--named-server-config"
          - "/app/servers.json"
          - "--pass-environment"
        networks:
          - name: "{{ llm_network_name }}"
        restart_policy: "unless-stopped"


- name: LiteLLM Proxy Setup
  become: true
  block:
    - name: Define LiteLLM Proxy related facts
      ansible.builtin.set_fact:
        litellm_proxy_config_full_host_path: "{{ litellm_proxy_config_dir_host }}/{{ litellm_proxy_config_filename }}"

    - name: Ensure LiteLLM Proxy config directory exists on host
      ansible.builtin.file:
        path: "{{ litellm_proxy_config_dir_host }}"
        state: directory
        mode: "0755"

    - name: Template LiteLLM Proxy config.yaml
      ansible.builtin.template:
        src: litellm_config.yaml.j2
        dest: "{{ litellm_proxy_config_full_host_path }}"
        mode: "0644"
      notify: Restart LiteLLM Proxy container

    - name: Define LiteLLM Proxy container environment variables
      ansible.builtin.set_fact:
        litellm_proxy_env_vars:
          LANGFUSE_PUBLIC_KEY: "{{ langfuse_homelab_public_key }}"
          LANGFUSE_SECRET_KEY: "{{ langfuse_homelab_secret_key }}"
          LANGFUSE_HOST: "{{ langfuse_host_for_litellm }}"
          LITELLM_MASTER_KEY: "{{ litellm_master_key }}"
          GEMINI_API_KEY: "{{ GEMINI_API_KEY }}"
          OPENROUTER_API_KEY: "{{ OPENROUTER_API_KEY }}"
          ANTHROPIC_API_KEY: "{{ ANTHROPIC_API_KEY }}"
          # LITELLM_LOG_LEVEL: "DEBUG"

    - name: Start LiteLLM Proxy container
      community.docker.docker_container:
        name: "{{ litellm_proxy_container_name }}"
        image: "{{ litellm_proxy_image }}"
        state: started
        detach: true
        ports:
          - "{{ litellm_proxy_port_host }}:{{ litellm_proxy_port_container }}"
        volumes:
          - "{{ litellm_proxy_config_full_host_path }}:/app/config.yaml:ro"
        env: "{{ litellm_proxy_env_vars }}"
        command: ["--config", "/app/config.yaml", "--port", "{{ litellm_proxy_port_container }}"] # Add --detailed_debug here if needed for troubleshooting
        networks:
          - name: "{{ llm_network_name }}"
        restart_policy: "unless-stopped"
      register: litellm_proxy_container_result

    - name: Debug LiteLLM Proxy container result
      ansible.builtin.debug:
        var: litellm_proxy_container_result
      when: litellm_proxy_container_result is defined and litellm_proxy_container_result.changed

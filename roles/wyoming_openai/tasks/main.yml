---
- name: Create data folders
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ uid }}"
    group: "{{ gid }}"
    recurse: yes
  with_items:
    - "{{ huggingface_cache_folder }}"
    - "{{ chatterbox_models_folder }}"
    - "{{ chatterbox_voices_folder }}"
    - "{{ chatterbox_longtext_data_folder }}"
    - "{{ chatterbox_frontend_build_folder }}"
  become: true

- name: Create voice sample file (placeholder)
  ansible.builtin.file:
    path: "{{ chatterbox_voice_sample_file }}"
    state: touch
    mode: "0644"
    owner: "{{ uid }}"
    group: "{{ gid }}"
  become: true

- name: Clone chatterbox-tts-api repository for frontend build
  ansible.builtin.git:
    repo: https://github.com/travisvn/chatterbox-tts-api.git
    dest: "{{ chatterbox_source_folder }}"
    version: main
    force: yes
  when: not ansible_check_mode

- name: Build frontend static files using Node container
  community.docker.docker_container:
    name: chatterbox-frontend-build
    image: node:20-alpine
    command: sh -c "cd /app/frontend && npm install && npm run build"
    volumes:
      - "{{ chatterbox_source_folder }}:/app:rw"
    cleanup: yes
    detach: false
  when: not ansible_check_mode

- name: Copy built frontend files to deployment folder
  ansible.builtin.copy:
    src: "{{ chatterbox_source_folder }}/frontend/dist/"
    dest: "{{ chatterbox_frontend_build_folder }}/"
    mode: preserve
    remote_src: yes
  when: not ansible_check_mode

- name: Start wyoming_openai stack
  community.docker.docker_compose_v2:
    project_name: wyoming-openai
    state: present
    definition:
      services:
        speaches:
          container_name: "{{ speaches_container_name }}"
          image: "{{ speaches_image }}"
          restart: unless-stopped
          ports:
            - "{{ speaches_port }}:8000"
          environment:
            - enable_ui=False
            - log_level=info
            - WHISPER__MODEL={{ stt_model }}
            - WHISPER__compute_type=int8_float32
          volumes:
            - "{{ huggingface_cache_folder }}:/home/ubuntu/.cache/huggingface/hub"
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
          labels:
            - "wud.tag.include=^v\\d+\\.\\d+\\.\\d+$"
          deploy:
            resources:
              reservations:
                devices:
                  - driver: nvidia
                    capabilities: ["gpu"]

        chatterbox-tts:
          container_name: "{{ chatterbox_container_name }}"
          # Use build context with uv-optimized Dockerfile for better performance
          build:
            context: https://github.com/travisvn/chatterbox-tts-api.git#main
            dockerfile: docker/Dockerfile.uv.gpu
          restart: unless-stopped
          ports:
            - "{{ chatterbox_tts_port }}:{{ chatterbox_tts_port }}"
          environment:
            # Server Configuration
            - PORT={{ chatterbox_tts_port }}
            - HOST=0.0.0.0
            - CORS_ORIGINS={{ chatterbox_cors_origins }}
            # TTS Model Settings
            - EXAGGERATION={{ chatterbox_exaggeration }}
            - CFG_WEIGHT={{ chatterbox_cfg_weight }}
            - TEMPERATURE={{ chatterbox_temperature }}
            - USE_MULTILINGUAL_MODEL={{ chatterbox_use_multilingual_model | string | lower }}
            # Text Processing
            - MAX_CHUNK_LENGTH={{ chatterbox_max_chunk_length }}
            - MAX_TOTAL_LENGTH={{ chatterbox_max_total_length }}
            # Long Text TTS Settings
            - LONG_TEXT_DATA_DIR=/data/long_text_jobs
            - LONG_TEXT_MAX_LENGTH={{ chatterbox_longtext_max_length }}
            - LONG_TEXT_CHUNK_SIZE={{ chatterbox_longtext_chunk_size }}
            - LONG_TEXT_SILENCE_PADDING_MS={{ chatterbox_longtext_silence_padding_ms }}
            - LONG_TEXT_JOB_RETENTION_DAYS={{ chatterbox_longtext_job_retention_days }}
            - LONG_TEXT_MAX_CONCURRENT_JOBS={{ chatterbox_longtext_max_concurrent_jobs }}
            # Voice and Model Settings
            - VOICE_SAMPLE_PATH=/app/voice-sample.mp3
            - DEVICE={{ chatterbox_device }}
            - MODEL_CACHE_DIR=/cache
            - VOICE_LIBRARY_DIR=/voices
            # NVIDIA/CUDA settings
            - NVIDIA_VISIBLE_DEVICES=all
            - NVIDIA_DRIVER_CAPABILITIES=compute,utility
            # Memory Management
            - MEMORY_CLEANUP_INTERVAL={{ chatterbox_memory_cleanup_interval }}
            - CUDA_CACHE_CLEAR_INTERVAL={{ chatterbox_cuda_cache_clear_interval }}
            - ENABLE_MEMORY_MONITORING={{ chatterbox_enable_memory_monitoring | string | lower }}
          volumes:
            - "{{ chatterbox_voice_sample_file }}:/app/voice-sample.mp3:ro"
            - "{{ chatterbox_models_folder }}:/cache"
            - "{{ chatterbox_voices_folder }}:/voices"
            - "{{ chatterbox_longtext_data_folder }}:/data/long_text_jobs"
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:{{ chatterbox_tts_port }}/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 300s
          deploy:
            resources:
              reservations:
                devices:
                  - driver: nvidia
                    count: 1
                    capabilities: [gpu]

        # Web UI for Chatterbox TTS - static files served by nginx with API proxy
        chatterbox-frontend:
          container_name: chatterbox-tts-frontend
          image: nginx:1.25-alpine
          ports:
            - "{{ chatterbox_frontend_port }}:80"
          volumes:
            - "{{ chatterbox_frontend_build_folder }}:/usr/share/nginx/html:ro"
            # Mount nginx config from repository with API proxy to chatterbox-tts
            - "{{ chatterbox_source_folder }}/frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro"
          depends_on:
            - chatterbox-tts
          restart: unless-stopped

        wyoming_openai:
          container_name: "{{ wyoming_openai_container_name }}"
          image: "{{ wyoming_openai_image }}"
          restart: unless-stopped
          ports:
            - "{{ wyoming_openai_port }}:10300"
          environment:
            WYOMING_URI: "{{ wyoming_uri }}"
            WYOMING_LOG_LEVEL: "{{ wyoming_log_level }}"
            WYOMING_LANGUAGES: "{{ wyoming_languages }}"
            STT_OPENAI_URL: "http://speaches:8000/v1"
            STT_MODELS: "{{ stt_model }}"
            STT_BACKEND: "SPEACHES"
            TTS_OPENAI_URL: "http://chatterbox-tts:{{ chatterbox_tts_port }}/v1"
            TTS_MODELS: "{{ tts_model }}"
            TTS_BACKEND: "{{ tts_backend }}"
            TTS_VOICES: "default Sabine Merkel"
            TTS_SPEED: "1.0"
          depends_on:
            speaches:
              condition: service_healthy
            chatterbox-tts:
              condition: service_healthy
          labels:
            - "wud.tag.include=^v\\d+\\.\\d+\\.\\d+$"
          deploy:
            resources:
              reservations:
                devices:
                  - driver: nvidia
                    capabilities: ["gpu"]

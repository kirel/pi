---
# tasks file for draw_things

- name: Ensure Draw Things models directory exists
  ansible.builtin.file:
    path: "{{ draw_things_models_path }}"
    state: directory
    mode: "0755"
    owner: "1000"
    group: "1000"
    recurse: yes
  become: true

- name: Ensure Draw Things models volume exists
  community.docker.docker_volume:
    name: "{{ draw_things_volume_name }}"
    driver_options:
      type: none
      device: "{{ draw_things_models_path }}"
      o: "bind,uid=1000,gid=1000"
    state: present
  become: true

- name: Ensure Draw Things container is running
  community.docker.docker_container:
    name: "{{ draw_things_container_name }}"
    image: "{{ draw_things_image }}"
    pull: true
    state: started
    restart_policy: unless-stopped
    device_requests:
      - driver: nvidia
        count: -1
        capabilities:
          - ["gpu"]
    ports:
      - "{{ draw_things_port }}:7859"
    volumes:
      - "{{ draw_things_volume_name }}:/grpc-models"
    command: ["gRPCServerCLI", "--model-browser", "/grpc-models"]
  become: true

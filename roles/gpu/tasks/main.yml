---
# tasks file for gpu
- name: Download CUDA keyring
  ansible.builtin.get_url:
    url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
    dest: /tmp/cuda-keyring_1.1-1_all.deb
    mode: '0644'
  become: true

- name: Install CUDA keyring
  ansible.builtin.apt:
    deb: /tmp/cuda-keyring_1.1-1_all.deb
  become: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Install CUDA toolkit and NVIDIA drivers
  ansible.builtin.apt:
    name:
      - cuda-toolkit
      - nvidia-open
    state: present
  become: true
  notify: reboot system

- name: Setup NVIDIA container toolkit repository
  block:
    - name: Add NVIDIA container repository GPG key
      ansible.builtin.apt_key:
        url: https://nvidia.github.io/libnvidia-container/gpgkey
        keyring: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
        state: present
      become: true

    - name: Add NVIDIA container repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/deb/amd64 /"
        state: present
        filename: nvidia-container-toolkit
      become: true

- name: Install NVIDIA Container Toolkit
  ansible.builtin.apt:
    name:
      - "nvidia-container-toolkit={{ nvidia_container_toolkit_version }}"
      - "nvidia-container-toolkit-base={{ nvidia_container_toolkit_version }}"
      - "libnvidia-container-tools={{ nvidia_container_toolkit_version }}"
      - "libnvidia-container1={{ nvidia_container_toolkit_version }}"
    state: present
    update_cache: true
    allow_downgrades: true
  become: true
  notify: restart docker

- name: Install nvtop and jq
  ansible.builtin.apt:
    name:
      - nvtop
      - jq
    state: present
    update_cache: true
  become: true

- name: Check if docker is configured for nvidia runtime
  ansible.builtin.shell: |
    if [ -f /etc/docker/daemon.json ]; then
      nvidia_runtime=$(jq -r '.runtimes.nvidia // "none"' /etc/docker/daemon.json)
      if [ "$nvidia_runtime" != "none" ]; then
        echo "configured"
      else
        echo "not_configured"
      fi
    else
      echo "no_file"
    fi
  register: docker_nvidia_configured
  changed_when: false
  become: true

- name: Configure nvidia-ctk runtime for docker
  ansible.builtin.command:
    cmd: nvidia-ctk runtime configure --runtime=docker
  become: true
  when: docker_nvidia_configured.stdout != "configured"
  register: nvidia_ctk_result
  changed_when:
    - docker_nvidia_configured.stdout != "configured"
    - nvidia_ctk_result is defined
    - "'No changes required' not in nvidia_ctk_result.stdout"
  notify: restart docker

- name: Create nvidia-power-limit service
  ansible.builtin.template:
    src: nvidia-power-limit.service.j2
    dest: /etc/systemd/system/nvidia-power-limit.service
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Apply persistence mode immediately
  ansible.builtin.command:
    cmd: "nvidia-smi -pm 1"
  become: true
  when: gpu_persistence_mode
  changed_when: false

- name: Check current GPU power limits
  ansible.builtin.shell: |
    nvidia-smi --query-gpu=power.limit --format=csv,noheader,nounits | tr -d ' '
  register: current_power_limits
  changed_when: false
  failed_when: false
  become: true

- name: Apply power limits immediately if different
  ansible.builtin.command:
    cmd: "nvidia-smi {% if item.uuid is defined %}-i {{ item.uuid }}{% endif %} -pl {{ item.power_limit | default(gpu_power_limit_watts) }}"
  become: true
  loop: "{{ gpu_configs | default([{'power_limit': gpu_power_limit_watts}]) }}"
  register: power_limit_applied
  changed_when: power_limit_applied.rc == 0
  when: current_power_limits.stdout != ""

- name: Apply graphics clock locks immediately
  ansible.builtin.command:
    cmd: "nvidia-smi -i {{ item.uuid }} -lgc {{ item.min_graphics_clock }},{{ item.max_graphics_clock }}"
  become: true
  loop: "{{ gpu_configs | default([]) }}"
  when: item.min_graphics_clock is defined
  changed_when: false

- name: Apply memory clock locks immediately
  ansible.builtin.command:
    cmd: "nvidia-smi -i {{ item.uuid }} -lmc {{ item.memory_clock }}"
  become: true
  loop: "{{ gpu_configs | default([]) }}"
  when: item.memory_clock is defined
  changed_when: false

- name: Enable and start nvidia-power-limit service
  ansible.builtin.systemd:
    name: nvidia-power-limit.service
    state: started
    enabled: true
    daemon_reload: true
  become: true

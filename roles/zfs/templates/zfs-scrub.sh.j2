#!/bin/bash
# ZFS Scrub Script
# Generated by Ansible - do not edit manually

POOL_NAME="{{ zfs_pool_name }}"
LOG_FILE="/var/log/zfs-scrub.log"

echo "$(date): Starting ZFS scrub on pool: $POOL_NAME" >> "$LOG_FILE"

# Check if a scrub is already running
if zpool status "$POOL_NAME" | grep -q "scrub in progress"; then
    echo "$(date): Scrub already in progress, skipping" >> "$LOG_FILE"
    exit 0
fi

# Start the scrub
zpool scrub "$POOL_NAME"

if [ $? -eq 0 ]; then
    echo "$(date): Scrub started successfully" >> "$LOG_FILE"
else
    echo "$(date): Failed to start scrub" >> "$LOG_FILE"
    exit 1
fi

# Wait for scrub to complete and log results
while zpool status "$POOL_NAME" | grep -q "scrub in progress"; do
    sleep 300  # Check every 5 minutes
done

echo "$(date): Scrub completed" >> "$LOG_FILE"
zpool status "$POOL_NAME" >> "$LOG_FILE"
echo "---" >> "$LOG_FILE"

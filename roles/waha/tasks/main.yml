---
- name: Ensure waha directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"
  loop:
    - "{{ waha_config_folder }}"
    - "{{ waha_sessions_folder }}"
  become: true

- name: Start WAHA container
  community.docker.docker_container:
    name: "{{ waha_container_name }}"
    image: "{{ waha_image }}"
    pull: true
    restart_policy: unless-stopped
    ports:
      - "{{ waha_port }}:3000"
    volumes:
      - "{{ waha_sessions_folder }}:/app/.sessions"
      - "{{ caddy_data_folder }}/caddy/pki/authorities/local/root.crt:/usr/local/share/ca-certificates/caddy_local_root.crt:ro"
    env:
      WHATSAPP_DEFAULT_ENGINE: "{{ waha_engine }}"
      WAHA_API_KEY: "{{ waha_api_key }}"
      WAHA_WEBHOOK_URL: "{{ waha_webhook_url | default('') }}"
      # Print QR code to console for easy setup if needed
      WAHA_PRINT_QR: "True"
      NODE_EXTRA_CA_CERTS: /usr/local/share/ca-certificates/caddy_local_root.crt
      WAHA_DASHBOARD_USERNAME: "{{ waha_dashboard_username }}"
      WAHA_DASHBOARD_PASSWORD: "{{ waha_dashboard_password }}"

    labels:
      homepage.group: "{{ services['waha'].group }}"
      homepage.name: "{{ services['waha'].name }}"
      homepage.href: "https://waha.lan }}"
      homepage.icon: "{{ services['waha'].icon }}"
      homepage.server: "{{ inventory_hostname }}"
      homepage.container: "{{ waha_container_name }}"
  become: true
  notify: Restart waha

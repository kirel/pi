---
- name: Install system dependencies for Borgmatic
  ansible.builtin.apt:
    name:
      - borgbackup
      - sshfs
      - libssl-dev
      - libacl1-dev
    state: present
    update_cache: yes
  become: true

- name: Remove system borgmatic if present
  ansible.builtin.apt:
    name: borgmatic
    state: absent
  become: true

- name: Install uv
  ansible.builtin.pip:
    name: uv
    state: present
    break_system_packages: true
  become: true

- name: Install Borgmatic via uv tool
  ansible.builtin.command:
    cmd: uv tool install borgmatic
    creates: /root/.local/bin/borgmatic
  environment:
    UV_TOOL_BIN_DIR: /usr/local/bin
  become: true

- name: Upgrade Borgmatic via uv tool
  ansible.builtin.command:
    cmd: uv tool upgrade borgmatic
  environment:
    UV_TOOL_BIN_DIR: /usr/local/bin
  become: true
  changed_when: false

- name: Create borgmatic configuration directory
  ansible.builtin.file:
    path: /etc/borgmatic.d
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true

- name: Create backup repository directory
  ansible.builtin.file:
    path: "{{ backup_local_repo }}"
    state: directory
    mode: '0700'
    owner: root
    group: root
  become: true

- name: Deploy borgmatic configuration
  ansible.builtin.template:
    src: "config-local.yaml.j2"
    dest: "/etc/borgmatic.d/config-local.yaml"
    mode: '0600'
    owner: root
    group: root
  become: true
  notify: Reload systemd daemon

- name: Initialize Borg repository
  ansible.builtin.command:
    cmd: uv tool run borgmatic --config /etc/borgmatic.d/config-local.yaml init --encryption repokey
  environment:
    UV_TOOL_BIN_DIR: /usr/local/bin
  become: true
  register: init_result
  failed_when: init_result.rc != 0 and "already exists" not in init_result.stderr
  changed_when: init_result.rc == 0

- name: Deploy systemd service unit
  ansible.builtin.copy:
    src: "borgmatic-local.service"
    dest: "/etc/systemd/system/borgmatic-local.service"
    mode: '0644'
  become: true
  notify: Reload systemd daemon

- name: Deploy systemd timer unit
  ansible.builtin.copy:
    src: "borgmatic-local.timer"
    dest: "/etc/systemd/system/borgmatic-local.timer"
    mode: '0644'
  become: true
  notify: Reload systemd daemon

- name: Flush handlers to apply systemd changes
  meta: flush_handlers

- name: Enable borgmatic timer
  ansible.builtin.systemd:
    name: borgmatic-local.timer
    enabled: yes
    state: started
  become: true